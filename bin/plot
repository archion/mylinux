#!/bin/bash
#file=`basename "$1"`
#cd `dirname "$1"`
silence=false
while getopts :s OPTION
do
    case $OPTION in
        s)
            silence=true
            ;;
    esac
done
shift $((OPTIND - 1))
for f in "$@"
do
	file=${f##*/}
	cd ${f/$file/.}
	plt=${file%.*}.plt
	if ! [ -f $plt ]; then
		if ! [ -f ${plt%%_*}.plt ]; then
			if grep -q "#data" "$file"; then
				sed -n "0,/#data/p" "$file" > $plt
			else
				cp gnuplot.plt $plt
			fi
		else
			plt=${file%%_*}.plt
		fi
	fi
	sed -i "s/\"-\"/\"$file\"/g" $plt
	sed -i "s/\"-\.\"/\"${file%.*}\.\"/g" $plt
	if grep -q "#data" "$file"; then
		sed -i "0,/#data/s/^/#/" "$file"
	fi
	gnuplot -p $plt
	if grep -q "##data" "$file" >/dev/null; then
		sed -i "0,/#data/s/^#//" "$file"
	fi
	sed -i "s/\"$file\"/\"-\"/g" $plt
	sed -i "s/\"${file%.*}\.\"/\"-\.\"/g" $plt
	#rm plot.plt
	if ! grep -q "#set output" $plt && ! $silence; then
		if ! ps ax | grep -e "[z]athura.*"${file%.*}"\." > /dev/null ; then
			zathura "${file%.*}".eps &
		fi
	fi
	if ! ps ax | grep -e "[g]vim -o $plt "${file%.*}".dat" > /dev/null  && ! $silence; then
		gvim -o $plt "${file%.*}".dat &
	fi
done
