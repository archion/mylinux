#!/bin/bash

if [[ $1 != "l" ]]; then
	ip=$(ssh YZD@192.168.0.206 -p 2222 'who -m |grep YZD |grep -oE "([0-9]{1,3}\.){3}[0-9]{1,3}"|head -n 1')
	if (($#>0));then
		ip=$1
	fi
	sed -i "s/HostName .*/HostName $ip/1" ~/.ssh/config
	upload
fi

f=$(ls -t *.f90|head -1)
sed -i "s/^[^#].*=.*out/out = ${f%.*}.out/" makefile 
make clean
make
t1=$(date +%F\ %T)
echo -e "\e[0;32;1m run \e[41;32;1m ${f%.*}.out \e[0;32;1m at $t1 \e[0m"
./${f%.*}.out
t2=$(date +%F\ %T)

if [[ $1 != "l" ]]; then
	download
else
	notify-send 'Program complete!' ${f%.*}.out' complete!' --icon=dialog-information
fi

dt=$(($(date -d "$t2" +%s) - $(date -d "$t1" +%s)))
day=$((dt/(60*60*24)))
dt=$((dt-day*(60*60*24)))
hour=$((dt/(60*60)))
dt=$((dt-hour*(60*60)))
min=$((dt/(60)))
sec=$((dt-min*(60)))
echo -e "\e[0;32;1m run \e[41;32;1m ${f%.*}.out \e[0;32;1m From $t1 to $t2 total time is ${day}D ${hour}h ${min}m ${sec}s \e[0m"
